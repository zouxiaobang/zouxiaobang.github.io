---
title: Linux(2) -- Linux系统开机过程问题排解及关机方法
date: 2018-01-09 22:43:45
tags:
---

------

## 1 正确的关机方法
Linux的关机不像Windows那般随意，可以直接按电源键几秒就关掉算了。
Linux如果不正常关机，有可能造成文件系统的损毁 -- 因为在关机时如果不是按照正常的服务关闭流程的话，有些数据可能来不及写入到文件中，从而这些服务文件可能会出现问题。

几个关机的命令：
**（只有root账号才能进行例如shutdown、reboot等命令）**
 - sync: 同步数据到磁盘
 - shutdown: 常用的关机命令 
 - reboot/halt/poweroff: 重启、关机命令

### 1.1 数据同步到磁盘：sync
计算机在运行的时候，所有的数据都要被读取到内存中，才能被CPU处理。处理完后又会被存回磁盘中。在内存和磁盘中，磁盘的读写速度显然是比较慢的，如果一直都在磁盘上进行读写操作，那么计算机的性能肯定是没有那么优秀的。
Linux为了解决这个问题，在默认的情况下，某些已经加载到内存中的数据就不会被写回磁盘中，通过暂存在内存中的方式，让你在重新操作该数据的时候，能直接从内存中取出，在速度上就能提升不少。
但是，问题也就出在这里，如果因为不正常关机而未在关机之前把内存中的数据写回磁盘中，就有可能造成数据的丢失。
所以，在关机之前多执行几次sync命令肯定没错的。

### 1.2 常用关机命令：shutdown
shutdown这个命令会通知系统中的所有进程，并通知关闭系统中的run level内的一些服务。
shutdown可完成的工作：

 - 可以自由选择关机模式：关机、重启或进入单用户操作模式
 - 可以设置关机时间
 - 可以自定义关机的通知信息
 - 可以仅仅发出警告信息
 - 可以选择是否使用fsck检查文件系统
 
shutdown的option参数参考：
root@www ~: shutdown [OPTION]... TIME [MESSAGE]
-r     系统服务停止之后重启。
-h     将系统服务停掉之后关机。
-H     将系统服务停掉之后关机。（使用halt命令关机）
-P     将系统服务停掉之后关机。（使用power off命令关机）
-c     取消正在进行的关机操作。这个选项没有option参数。
-k     只传递警告信息给所有用户，并不执行关机操作。

例子：
root@www ~:shutdown -h now
    现在就关机
root@www ~:shutdown -h 20:25
    在20:25这个时间点关机
root@www ~:shutdown -h +10
    10分钟后关机
root@www ~:shutdown -r now
    立即重启
root@www ~:shutdown -r +30 "the system will reboot after 30 min"
    系统在30分钟后重启并提供警告信息
root@www ~:shutdown -k now "the is the message with shutdown"
    发出警告信息，但并不关机
    
（注意：时间参数比较加入，不然shutdown命令会自动跳到run-level 1的模式下（单用户维护的登录情况））

### 1.3 重启、关机：reboot、halt、poweroff
shutdown实际上是调用init 0, init 0会清理一些服务，然后再调用halt或者poweroff。
halt和poweroff的主要区别，在没有没有acpi的系统上，halt只是关闭了系统，而没有关闭电源，必须手动关闭电源，而poweroff会发送一个关闭电源的信号给acpi。
而在现在的系统中，这些命令基本就都一样了。
更建议使用init 0来关机。

### 1.4 切换执行等级：init
init改变的就是run-level，主要有7中等级模式
| Run Level      | 描述   |
| --------   | -----:  |
|  0     | 关机 |
|  1     | 单用户模式 |
|  2     | 多用户模式，但无网络连接 |
|  3     | 多用户模式，纯命令行模式 |
|  4     | 用户自定义 |
|  5     | 多用户模式，图形界面模式 |
|  6     | 重启 |
如何来切换模式呢？
可以使用init这个命令，例如，关机可以使用init 0来替代。

## 2 开机过程的问题排解
### 2.1 文件系统出现错误
文件系统损坏的原因一般有以下两个：

 - 因为断电或不正常关机所导致的文件系统发生错误。
 - 硬盘使用率过高，或使用时的环境不良
 
解决文件系统出现的错误一般要根据出错的扇区来排查。
#### 2.1.1 如果根目录没有损坏
假如坏的分区是/dev/sda7，那么操作步骤如下：
 - 在开机时，屏幕显示“press root password or ctrl+D”，此时输入root密码，进行单用户模式维护工作。
 - 输入“fsck /dev/sda7”，此时开始检测sda7分区的错误，并在屏幕上显示正在修复硬盘的信息，如果发现错误，就会显示“clear [Y/N]?”，直接输入Y。
 - 修复完成后，直接重启。
#### 2.1.2 如果根目录坏了
只能将该硬盘拔出，接到另一台Linux系统的计算机上，并且不要挂载该硬盘。然后以root身份进入并执行“fsck /dev/sdb1”。
为什么是/dev/sdb1？
因为这个损坏的硬盘接入到其他计算机中，就充当了第二个硬盘，所以编号是sdb，而其根目录是在第一个分区中的，所以为sdb1。
#### 2.1.3 如果硬盘坏了
那就只能换硬盘了。

### 2.2 修改root密码
如果忘记了root的密码，其实不用重载系统，只需要使用单用户模式进入更改密码即可。具体步骤:
系统重启，读秒的时候按下任意键，按e进入grub编辑模式：
```java
root (hd0, 0)
kernel /vmlinuz-2.6.18-128.e15 ro root=LABEL=/ rhgb quiet
initrd /initrd-2.6.18-128.e15.img
```
在kernel那一行后面按下e，添加“single”：
```java
kernel /vmlinuz-2.6.18-128.e15 ro root=LABEL=/ rhgb quiet single
```
按下【Enter】键，再按下b就可以开机进入单用户模式。此时只需要输入“passed”来修改密码即可：
```java
[root@www ~]# passwd
```
按enter后系统提示要输入两次密码，即可修改成功。